#!/usr/bin/python

import twisted.internet.main
from twisted.spread import pb

import McFoo.playqueue
import McFoo.dj
import McFoo.volume
import McFoo.server.pb
import McFoo.suggest
import McFoo.score
import select
import os

from errno import EINTR

from twisted.protocols import protocol
from twisted.internet import main

if __name__ == "__main__":
    import dj

    profileTable=McFoo.score.ProfileTable()
    filler=McFoo.suggest.Suggestions("/data/music", profileTable)
    playqueue = McFoo.playqueue.PlayQueue(filler.get)
    dj = McFoo.dj.Dj(playqueue)
    volume = McFoo.volume.VolumeControl()

    app = main.Application("dj")
    service=McFoo.server.pb.server(app, dj, playqueue, volume, profileTable)
    perspective=service.getPerspectiveNamed("guest")
    perspective.setService(service)
    perspective.makeIdentity("guest")

    port=25706
    try:
        port=int(os.environ['MCFOOPORT'])
    except KeyError:
        pass

    app.listenOn(port, pb.BrokerFactory(pb.AuthRoot(app)))

    app.save("start")
