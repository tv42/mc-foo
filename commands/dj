#!/usr/bin/env python2

### Twisted Preamble
# This makes sure that users don't have to set up their environment
# specially in order to run these programs from bin/.
import sys,os,string

if string.find(os.path.abspath(sys.argv[0]),'Twisted') != -1:
    sys.path.append(os.path.dirname(
        os.path.dirname(os.path.abspath(sys.argv[0])))) 
### end of preamble

# Twisted Imports
import twisted.internet.main
from twisted.spread import pb

import McFoo.playqueue
import McFoo.dj
import McFoo.inputsong
import McFoo.volume
import McFoo.server.pb
import select
import os
import twisted.python.delay

from errno import EINTR

def main():
    playqueue = McFoo.playqueue.PlayQueue()
    dj = McFoo.dj.Dj(playqueue)
    inputsong = McFoo.inputsong.InputSong(playqueue, dj.ensure_music)
    volume = McFoo.volume.VolumeControl()

    XMLRPC = McFoo.server.pb.server(dj, playqueue, volume)

    bf = pb.BrokerFactory()
    bf.addService("dj", XMLRPC)

    app = twisted.internet.main.Application("dj")

    port=25706
    try:
        port=int(os.environ['MCFOOPORT'])
    except KeyError:
        pass

    app.listenOn(port, bf)

    timer=twisted.python.delay.Delayed()
    timer.loop(playqueue.ensure_fill, 1)
    app.addDelayed(timer)

    app.run()


if __name__ == "__main__":
    main()
